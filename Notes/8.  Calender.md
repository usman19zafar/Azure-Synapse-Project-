===============================================================================
SOP: Calendar Dimension Ingestion Using OPENROWSET (CSV, ADLS Gen2)
===============================================================================

1. PURPOSE
----------
Define the standard procedure for reading, validating, and projecting the
calendar.csv file stored in ADLS Gen2 into a structured tabular format using
OPENROWSET with CSV parsing (PARSER_VERSION = 2.0). This ensures consistent
ingestion regardless of header presence, schema binding, or row offsets.


2. SCOPE
--------
Applies to:
- Azure Synapse Serverless SQL
- Azure SQL On-Demand
- External data sources referencing ADLS Gen2
- CSV files containing calendar dimension data


3. PREREQUISITES
----------------
- External data source named "nyctaxidata" must exist.
- File path must be: raw/calendar.csv
- CSV must contain 12 columns in the correct order.
- Collation must be explicitly defined for text fields.


4. DEFINITIONS
--------------

+------------------+--------------------------------------------------------------+
| Term             | Meaning                                                      |
+------------------+--------------------------------------------------------------+
| HEADER_ROW       | Indicates whether the CSV contains a header row.             |
| FIRSTROW         | Specifies first row of data when HEADER_ROW = FALSE.         |
| Schema Binding   | Using a WITH clause to enforce column types.                 |
| Projection       | Selecting columns after ingestion.                           |
+------------------+--------------------------------------------------------------+


5. PROCEDURE
------------

STEP 1: Validate File Accessibility (Direct ABFSS Path)
-------------------------------------------------------

Purpose: Confirm storage access, parser behavior, and header recognition.

```SQL:
SELECT
    TOP 100 *
FROM OPENROWSET(
        BULK 'abfss://nyctaxidata@786.dfs.core.windows.net/raw/calendar.csv',
        FORMAT = 'CSV',
        PARSER_VERSION = '2.0',
        HEADER_ROW = TRUE
) AS result;

Expected Outcome:
- File loads successfully
- Column names come from header row
- No schema binding yet
```

STEP 2: Load Calendar with Schema Binding (Using DATA_SOURCE)
-------------------------------------------------------------

Purpose: Enforce data types and collation.

```SQL:
SELECT *
FROM OPENROWSET(
        BULK 'raw/calendar.csv',
        DATA_SOURCE = 'nyctaxidata',
        FORMAT = 'CSV',
        PARSER_VERSION = '2.0',
        HEADER_ROW = TRUE
)
WITH (
        date_key        INT,
        date            DATE,
        year            SMALLINT,
        month           TINYINT,
        day             TINYINT,
        day_name        VARCHAR(10) COLLATE Latin1_General_100_CI_AS_SC_UTF8,
        day_of_year     SMALLINT,
        week_of_month   TINYINT,
        week_of_year    TINYINT,
        month_name      VARCHAR(10) COLLATE Latin1_General_100_CI_AS_SC_UTF8,
        year_month      INT,
        year_week       INT
) AS cal;
```

Expected Outcome:
- All 12 columns typed correctly
- UTF-8 collation applied to text fields
- Header row skipped automatically


STEP 3: Load Calendar When HEADER_ROW = FALSE
---------------------------------------------

Purpose: Use when file has no header row or when skipping header manually.

```SQL:
SELECT
    date_key,
    date,
    year,
    month,
    day,
    day_name,
    day_of_year,
    week_of_month,
    week_of_year,
    month_name,
    year_month,
    year_week
FROM OPENROWSET(
        BULK 'raw/calendar.csv',
        DATA_SOURCE = 'nyctaxidata',
        FORMAT = 'CSV',
        PARSER_VERSION = '2.0',
        HEADER_ROW = FALSE,
        FIRSTROW = 2
)
WITH (
        date_key        INT,
        date            DATE,
        year            SMALLINT,
        month           TINYINT,
        day             TINYINT,
        day_name        VARCHAR(10) COLLATE Latin1_General_100_CI_AS_SC_UTF8,
        day_of_year     SMALLINT,
        week_of_month   TINYINT,
        week_of_year    TINYINT,
        month_name      VARCHAR(10) COLLATE Latin1_General_100_CI_AS_SC_UTF8,
        year_month      INT,
        year_week       INT
) AS cal;
```

Expected Outcome:
- Header row manually skipped
- Schema binding enforced
- Clean, typed calendar rows returned


6. VALIDATION CHECKLIST
-----------------------

+-------------------------------+------------------+
| Check                         | Expected Result  |
+-------------------------------+------------------+
| File loads without errors     | Yes              |
| Column count = 12             | Yes              |
| Date column parses as DATE    | Yes              |
| Collation applied to text     | Yes              |
| FIRSTROW aligned correctly    | Yes              |
| No nulls or truncation        | Yes              |
+-------------------------------+------------------+


7. COMMON FAILURE MODES
-----------------------

+------------------------------+-------------------------------------------+------------------------------+
| Issue                        | Cause                                     | Fix                          |
+------------------------------+-------------------------------------------+------------------------------+
| Incorrect syntax near ','    | Stray timestamp or contamination in SQL   | Remove extra characters      |
| Invalid column name 'c1'     | WITH clause overrides auto c1..cN names   | Use schema column names      |
| Truncated text               | Wrong parser or missing collation         | Use PARSER_VERSION = 2.0     |
| Wrong row count              | Misaligned HEADER_ROW / FIRSTROW          | Align both correctly         |
+------------------------------+-------------------------------------------+------------------------------+


8. BOUNDARY-DOCUMENT RULE
-------------------------
All calendar ingestion must use schema binding, explicit collation, and
documented header handling. No ingestion is valid unless it passes the
validation checklist.

===============================================================================
END OF SOP
===============================================================================

